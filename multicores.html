

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Multicores &mdash; Pragmatic D Tutorial</title>
    
    <link rel="stylesheet" href="_static/marcelene.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Pragmatic D Tutorial" href="index.html" />
    <link rel="next" title="Collections" href="collections.html" />
    <link rel="prev" title="C Interoperability" href="c.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="index.html">Pragmatic D Tutorial</a></div>
        <div class="rel">
          <a href="c.html" title="C Interoperability"
             accesskey="P">previous</a> |
          <a href="collections.html" title="Collections"
             accesskey="N">next</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="multicores">
<h1>Multicores<a class="headerlink" href="#multicores" title="Permalink to this headline">¶</a></h1>
<p>Since computers with multiple cores are the norm today,
let us discuss how this can be exploited with D.</p>
<p>While concurrency and parallelism are
<a class="reference external" href="http://stackoverflow.com/questions/1050222/concurrency-vs-parallelism-what-is-the-difference">actually different concepts</a>,
we will not discuss them separately,
because programmers usually encounter them at same time anyways.
However, this means we only provide an overview here.</p>
<div class="section" id="threads">
<h2>Threads<a class="headerlink" href="#threads" title="Permalink to this headline">¶</a></h2>
<p>The basic mechanism for threads managed by the operating system
(PThread) is provided by <tt class="docutils literal"><span class="pre">std.concurrency</span></tt>.</p>
<div class="highlight-d"><div class="highlight"><pre><span class="k">import</span> <span class="n">std</span><span class="p">.</span><span class="n">stdio</span><span class="p">;</span>
<span class="k">import</span> <span class="n">std</span><span class="p">.</span><span class="n">concurrency</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">spawnedFunc</span><span class="p">(</span><span class="n">Tid</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Receive a message from the owner thread.</span>
  <span class="n">receive</span><span class="p">(</span>
    <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="n">writeln</span><span class="p">(</span><span class="s">&quot;Received the number &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);}</span>
  <span class="p">);</span>

  <span class="c1">// Send a message back to the owner thread</span>
  <span class="c1">// indicating success.</span>
  <span class="n">send</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// Start spawnedFunc in a new thread.</span>
  <span class="k">auto</span> <span class="n">tid</span> <span class="p">=</span> <span class="n">spawn</span><span class="p">(&amp;</span><span class="n">spawnedFunc</span><span class="p">,</span> <span class="n">thisTid</span><span class="p">);</span>

  <span class="c1">// Send the number 42 to this new thread.</span>
  <span class="n">send</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="mi">42</span><span class="p">);</span>

  <span class="c1">// Receive the result code.</span>
  <span class="k">auto</span> <span class="n">wasSuccessful</span> <span class="p">=</span> <span class="n">receiveOnly</span><span class="p">!(</span><span class="kt">bool</span><span class="p">);</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">wasSuccessful</span><span class="p">);</span>
  <span class="n">writeln</span><span class="p">(</span><span class="s">&quot;Successfully printed number.&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Once you use threads,
keep in mind that in D global variables are thread-local.
You can declare them global to the whole process with the <tt class="docutils literal"><span class="pre">shared</span></tt> qualifier.</p>
<div class="highlight-d"><div class="highlight"><pre><span class="n">shared</span> <span class="kt">int</span> <span class="n">countA</span><span class="p">;</span>  <span class="c1">// global counter</span>
<span class="kt">int</span> <span class="n">countB</span><span class="p">;</span>         <span class="c1">// thread-local counter</span>
</pre></div>
</div>
</div>
<div class="section" id="tasks">
<h2>Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h2>
<p>This is about the lightweight thread variant,
which is managed by the program itself.
It is also called user-level threads.
Since the tasks are usually executed by a thread pool,
they are run in parallel as well.</p>
<div class="highlight-d"><div class="highlight"><pre><span class="k">import</span> <span class="n">std</span><span class="p">.</span><span class="n">algorithm</span><span class="p">,</span> <span class="n">std</span><span class="p">.</span><span class="n">parallelism</span><span class="p">,</span> <span class="n">std</span><span class="p">.</span><span class="n">range</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Parallel reduce can be combined with</span>
    <span class="c1">// std.algorithm.map to interesting effect.</span>
    <span class="c1">// The following example (thanks to Russel Winder)</span>
    <span class="c1">// calculates pi by quadrature  using</span>
    <span class="c1">// std.algorithm.map and TaskPool.reduce.</span>
    <span class="c1">// getTerm is evaluated in parallel as needed by</span>
    <span class="c1">// TaskPool.reduce.</span>
    <span class="c1">//</span>
    <span class="c1">// Timings on an Athlon 64 X2 dual core machine:</span>
    <span class="c1">//</span>
    <span class="c1">// TaskPool.reduce:       12.170 s</span>
    <span class="c1">// std.algorithm.reduce:  24.065 s</span>

    <span class="n">immutable</span> <span class="n">n</span> <span class="p">=</span> <span class="mi">1_000_000_000</span><span class="p">;</span>
    <span class="n">immutable</span> <span class="n">delta</span> <span class="p">=</span> <span class="mf">1.0</span> <span class="p">/</span> <span class="n">n</span><span class="p">;</span>

    <span class="kt">real</span> <span class="n">getTerm</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">immutable</span> <span class="n">x</span> <span class="p">=</span> <span class="p">(</span> <span class="n">i</span> <span class="p">-</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="p">*</span> <span class="n">delta</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">delta</span> <span class="p">/</span> <span class="p">(</span> <span class="mf">1.0</span> <span class="p">+</span> <span class="n">x</span> <span class="p">*</span> <span class="n">x</span> <span class="p">)</span> <span class="p">;</span>
    <span class="p">}</span>

    <span class="n">immutable</span> <span class="n">pi</span> <span class="p">=</span> <span class="mf">4.0</span> <span class="p">*</span> <span class="n">taskPool</span><span class="p">.</span><span class="n">reduce</span><span class="p">!</span><span class="s">&quot;a + b&quot;</span><span class="p">(</span>
        <span class="n">std</span><span class="p">.</span><span class="n">algorithm</span><span class="p">.</span><span class="n">map</span><span class="p">!</span><span class="n">getTerm</span><span class="p">(</span><span class="n">iota</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is the same mechanism that is used by
Google Go, Rust, Erlang, and others.
Try the <a class="reference external" href="http://vibed.org/">Vibe.d</a> web framework for an integrated environment in this style.
However, D is not specialized for this
and permits some mistakes.
If a task calls a blocking function (e.g. read a file),
the executing thread blocks.
Since the maximal parallelism is defined by number of running threads in the underlying pool,
this might leave a core idle,
even if there are more tasks to run.
Specialized languages can simply start another thread,
to compensate for the blocking.
In D pool size maintenance must be done manually
and is probably forgotten in most cases.
You are fine,
if you can restrict yourself to asynchronous IO.</p>
</div>
<div class="section" id="synchronization">
<h2>Synchronization<a class="headerlink" href="#synchronization" title="Permalink to this headline">¶</a></h2>
<p>Once you have parallelism,
usually concurrency arises and the need for synchronization.
Of course,
D provides the ususal suspects:
Locks,
semaphores,
atomic variables.</p>
</div>
<div class="section" id="memory-model">
<h2>Memory Model<a class="headerlink" href="#memory-model" title="Permalink to this headline">¶</a></h2>
<p>Currently, D has no specified memory model.
However, you can assume that it will follow the intentions of C++ memory model.
This means:
Sequential consistency for data-race-free prpgrams.
In other words:
Properly synchronize your stuff with locks and stuff from the standard library
and everything will behave to your intuition.
It only becomes difficult,
if your requirements are tighter
such that lower-level mechanisms must be used.</p>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="hello.html">Hello World</a></li>
<li class="toctree-l1"><a class="reference internal" href="philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="others.html">Other Languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="package.html">Packaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimization.html">Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="idiomatic.html">Idiomatic D</a></li>
<li class="toctree-l1"><a class="reference internal" href="meta.html">Meta Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory.html">Memory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="c.html">C Interoperability</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Multicores</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#threads">Threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tasks">Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#synchronization">Synchronization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memory-model">Memory Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="collections.html">Collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="unicode.html">Unicode</a></li>
<li class="toctree-l1"><a class="reference internal" href="floating.html">Floating Point</a></li>
<li class="toctree-l1"><a class="reference internal" href="stdlib.html">Standard Library: Short Tour</a></li>
<li class="toctree-l1"><a class="reference internal" href="ide.html">IDE</a></li>
<li class="toctree-l1"><a class="reference internal" href="gui.html">GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="next.html">What Next?</a></li>
<li class="toctree-l1"><a class="reference internal" href="fineprint.html">Fineprint</a></li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="c.html" title="C Interoperability"
             >previous</a> |
          <a href="collections.html" title="Collections"
             >next</a>
            <br/>
            <a href="_sources/multicores.txt"
               rel="nofollow">Show Source</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; Copyright 2013, Andreas Zwinkau.
      Last updated on 2013-11-28.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
        </div>
        <div class="clearer"></div>
        <div id="feedback">
          For further questions about D, ask on the <a href="http://forum.dlang.org/group/digitalmars.D.learn">D.learn forum</a>.
          For feedback on this tutorial <a href="mailto:qznc@web.de">write me an email to qznc@web.de</a>.
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>